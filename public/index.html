<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prize Wheel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    .glow {
      box-shadow: 0 0 40px rgba(99,102,241,.25), inset 0 0 40px rgba(99,102,241,.15);
    }

    h1, #result {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", sans-serif;
      letter-spacing: -0.02em;
    }

    @keyframes pulseGlow {
      0%,100% { text-shadow:0 0 4px #fff,0 0 8px #fff,0 0 16px #f0f,0 0 24px #f0f; transform: scale(1);}
      50% { text-shadow:0 0 8px #fff,0 0 16px #fff,0 0 32px #ff0,0 0 48px #ff0; transform: scale(1.15);}
    }

    .winnerGlow {
      animation: pulseGlow 1s ease-in-out infinite;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-6
             bg-gradient-to-br from-purple-900 via-fuchsia-800 to-black
             text-white">
  <div class="w-full max-w-md text-center">
    <h1 class="text-3xl sm:text-4xl font-extrabold mb-6 drop-shadow-lg">
      üéâ Prize Wheel
    </h1>
   <div class="mb-6 p-4 bg-purple-800 rounded-lg border-2 border-fuchsia-500 shadow-lg text-center">
      <p class="text-xl font-semibold text-white mb-2">
        üéüÔ∏è How to Enter the Prize Wheel
      </p>
      <p class="text-lg font-bold">
        Type 
        <span class="bg-black text-yellow-300 px-2 py-1 rounded shadow-lg">
          !ticket
        </span> 
        in TikTok live chat
      </p>
    </div>

    <div class="relative mx-auto w-80 h-80 sm:w-96 sm:h-96">
      <canvas id="wheel" width="384" height="384" class="rounded-full glow"></canvas>
      <div class="pointer-events-none absolute -top-1 left-1/2 -translate-x-1/2">
        <div class="w-0 h-0 border-l-[14px] border-r-[14px] border-t-[22px]
                    border-l-transparent border-r-transparent border-t-yellow-400
                    drop-shadow-[0_0_10px_rgba(250,204,21,0.8)]">
        </div>
      </div>
      <button id="spinBtn"
        class="absolute inset-0 m-auto h-14 w-28 rounded-full font-bold tracking-wide
               bg-fuchsia-600 hover:bg-fuchsia-500 active:bg-fuchsia-700
               transition-colors shadow-xl">
        SPIN
      </button>
    </div>

    <p id="result" class="mt-6 text-2xl font-semibold min-h-[2.5rem] drop-shadow-lg"></p>

    <div class="flex justify-center gap-4 mt-4" id="debugButtons" style="display:none;">
      <button id="simulateEntry" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-500 shadow">
        Simulate Ticket Entry (Debug Only)
      </button>
    </div>

    <!-- Reset Entries is always visible -->
    <div class="flex justify-center mt-4">
      <button id="resetEntriesBtn" class="px-4 py-2 rounded bg-red-600 hover:bg-red-500 shadow">
        Reset Entries
      </button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const spinBtn = document.getElementById("spinBtn");
    const resultEl = document.getElementById("result");
    const simulateEntryBtn = document.getElementById("simulateEntry");
    const resetEntriesBtn = document.getElementById("resetEntriesBtn");
    const debugButtonsDiv = document.getElementById("debugButtons");

    // Detect debug mode from URL query ?debug=true
    const urlParams = new URLSearchParams(window.location.search);
    const debugMode = urlParams.get('debug') === 'true';
    if(debugMode) {
      debugButtonsDiv.style.display = 'flex';
    }

    let entries = [];
    const colors = ["#F43F5E","#3B82F6","#10B981","#F59E0B","#8B5CF6","#EC4899","#22D3EE","#A3E635"];
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const size = canvas.width;
    const radius = size / 2;
    let currentRotation = 0;
    let spinning = false;

    function escapeHtml(str) {
      return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    function mod(a,n){ return ((a%n)+n)%n; }

    function drawWheel(highlightIndex=null){
      const n = entries.length;
      if(n === 0) {
        ctx.clearRect(0,0,size,size);
        ctx.beginPath();
        ctx.arc(radius,radius,radius-1,0,Math.PI*2);
        ctx.fillStyle="#0F172A";
        ctx.fill();
        return;
      }

      const seg = Math.PI*2/n;
      ctx.clearRect(0,0,size,size);

      ctx.beginPath();
      ctx.arc(radius,radius,radius-1,0,Math.PI*2);
      ctx.lineWidth = 8;
      ctx.strokeStyle="rgba(255,255,255,0.15)";
      ctx.stroke();

      for(let i=0;i<n;i++){
        const start=i*seg, end=start+seg;
        ctx.beginPath();
        ctx.moveTo(radius,radius);
        ctx.arc(radius,radius,radius-8,start,end);
        ctx.closePath();
        ctx.fillStyle = colors[i % colors.length];
        ctx.fill();

        if(highlightIndex===i){
          ctx.save();
          ctx.clip();
          const grad=ctx.createRadialGradient(radius,radius,10,radius,radius,radius);
          grad.addColorStop(0,"rgba(255,255,255,0.15)");
          grad.addColorStop(1,"rgba(255,255,255,0)");
          ctx.fillStyle=grad;
          ctx.fillRect(0,0,size,size);
          ctx.restore();
        }

        ctx.save();
        ctx.translate(radius,radius);
        ctx.rotate(start + seg/2);
        ctx.textAlign="right";
        ctx.fillStyle="white";
        ctx.font="600 16px Inter, ui-sans-serif, system-ui, sans-serif";
        ctx.fillText(entries[i], radius-24, 6);
        ctx.restore();
      }

      ctx.beginPath();
      ctx.arc(radius,radius,34,0,Math.PI*2);
      ctx.fillStyle="#0F172A";
      ctx.fill();
      ctx.beginPath();
      ctx.arc(radius,radius,34,0,Math.PI*2);
      ctx.lineWidth=3;
      ctx.strokeStyle="rgba(255,255,255,0.25)";
      ctx.stroke();
    }

    function renderWithRotation(theta, highlightIndex=null){
      ctx.save();
      ctx.translate(radius,radius);
      ctx.rotate(theta);
      ctx.translate(-radius,-radius);
      drawWheel(highlightIndex);
      ctx.restore();
    }

    function animateToIndex(targetIndex, winnerName){
      if(spinning || entries.length===0) return;
      spinning=true;
      resultEl.textContent="";
      spinBtn.disabled=true;
      spinBtn.classList.add('opacity-50','cursor-not-allowed');

      const spins = Math.floor(Math.random()*3)+5;
      const seg = Math.PI*2/entries.length;
      const desiredPointerAngle = (targetIndex + 0.5) * seg;
      const targetThetaMod = mod(-Math.PI/2 - desiredPointerAngle, Math.PI*2);
      const currentMod = mod(currentRotation, Math.PI*2);
      const delta = mod(targetThetaMod - currentMod, Math.PI*2);
      const targetRotation = currentRotation + spins*Math.PI*2 + delta;

      const duration = 4800;
      const start = performance.now();
      const initial = currentRotation;

      function animate(now){
        const t = Math.min((now-start)/duration,1);
        const ease = 1 - Math.pow(1-t,3);
        currentRotation = initial + ease*(targetRotation-initial);
        renderWithRotation(currentRotation);
        if(t<1){
          requestAnimationFrame(animate);
        } else {
          spinning=false;
          currentRotation=mod(currentRotation,Math.PI*2);
          renderWithRotation(currentRotation,targetIndex);
          resultEl.innerHTML=`üéØ Winner: <span class="font-bold winnerGlow">${escapeHtml(winnerName)}</span>`;
          confetti({
            particleCount:150,
            spread:70,
            origin:{y:0.6},
            colors: colors
          });
          spinBtn.disabled=false;
          spinBtn.classList.remove('opacity-50','cursor-not-allowed');
        }
      }
      requestAnimationFrame(animate);
    }

    function renderWheel() {
      renderWithRotation(currentRotation);
    }

    spinBtn.addEventListener("click",()=>{
      if(entries.length===0) return;
      const winnerIndex = Math.floor(Math.random()*entries.length);
      const winnerName = entries[winnerIndex];
      animateToIndex(winnerIndex, winnerName);
    });

    if(debugMode){
      simulateEntryBtn.addEventListener("click",()=>{
        const randomUser = "User" + Math.floor(Math.random()*1000);
        if(!entries.includes(randomUser)) entries.push(randomUser);
        renderWheel();
      });
    }

    resetEntriesBtn.addEventListener("click",()=>{
      entries = [];
      currentRotation = 0;
      resultEl.textContent="";
      renderWheel();
    });

    renderWheel();
  </script>
</body>
</html>
